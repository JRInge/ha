---
# Sensors for CO2 intensity and grid energy mix
# Data comes from National Grid Energy Distribution Plc (previously Western
# Power Distribution).
# API documentation at https://wpdcarbonapi.docs.apiary.io/
# Further info at https://carbontracer.nationalgrid.co.uk/
########

co2_sensors:
  sensor:
    - platform: rest
      name: "Carbon Tracer CO2 intensity"
      resource: https://carbontracer.westernpower.co.uk/carbonapi/get_carbon_intensity_now/128239
      scan_interval: 180
      icon: mdi:molecule-co2
      state_class: measurement
      unit_of_measurement: gCO2eq/kWh
      value_template: "{{ value_json.data }}"
    - platform: rest
      name: "Carbon Tracer Grid energy mix"
      resource: https://carbontracer.westernpower.co.uk/carbonapi/get_energy_mix_now/128239
      scan_interval: 180
      value_template: "OK"
      json_attributes_path: "$.data"
      json_attributes:
        - "Combined Heat & Power"
        - "Biomass & Energy Crops"
        - "European Interconnect"
        - "Wind"
        - "Gas Turbine"
        - "Pumped Storage"
        - "Solar"
        - "Nuclear"
        - "Coal"
        - "Various"
        - "Hydro"
    - platform: rest
      name: "Bristol energy demand"
      resource: https://carbontracer.nationalgrid.co.uk/carbonapi/get_demand_now/128239
      value_template: "{{ value_json.data }}"
      state_class: measurement
      device_class: power
      unit_of_measurement: MW
  template:
    sensor:
    - name: "Carbon Tracer Grid fossil fuel percentage"
      icon: mdi:molecule-co2
      state_class: measurement
      unit_of_measurement: '%'
      state: |-
        {% set ns = namespace(sum=0) -%}
        {%- for key, val in states.sensor.carbon_tracer_grid_energy_mix.attributes.items() -%}
        {%- set ns.sum = ns.sum + float(val, 0) -%}
        {%- endfor -%}
        {{ (100 * (
          state_attr('sensor.carbon_tracer_grid_energy_mix', 'Coal')
            | default(0, true)
          + state_attr('sensor.carbon_tracer_grid_energy_mix', 'European Interconnect')
            | default(0, true) + state_attr('sensor.carbon_tracer_grid_energy_mix', 'Gas Turbine') | default(0, true)) / ns.sum)  | round(2) }}
...
